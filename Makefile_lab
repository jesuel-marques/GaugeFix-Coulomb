INCLUDE_DIR := include
SOURCE_DIR := src
BUILD_DIR := build
 
RM = rm -f
CC := mpiicc
CFLAGS := -I$(INCLUDE_DIR) -lm -O3 -ipo -xHASWELL -axSKYLAKE,CASCADELAKE,TIGERLAKE -qopt-zmm-usage=high -qopenmp -DMPI_CODE -DNUM_THREADS=`nproc` -diag-disable=10441

WARNINGS:= -Wall -Wextra

LIBS := -lm


SOURCES := $(wildcard $(SOURCE_DIR)/*.c)

_OBJECTS = $(patsubst $(SOURCE_DIR)/%.c, %.o, $(SOURCES))
OBJECTS = $(patsubst %, $(BUILD_DIR)/%, $(_OBJECTS))

_DEPENDS = $(patsubst $(SOURCE_DIR)/%.c, %.d, $(SOURCES))
DEPENDS = $(patsubst %, $(BUILD_DIR)/%, $(_DEPENDS))

BINARIES = gauge_fix_coulomb_mpi

.PHONY: all clean

all: $(BINARIES)

gauge_fix_coulomb_mpi: $(OBJECTS) gauge_fix_coulomb_mpi.c
	$(CC) -o $@ $^ $(CFLAGS) $(WARNINGS) $(LIBS) 


verify_gauge_fixing: $(OBJECTS) verify_gauge_fixing.c
	$(CC) -o $@ $^ $(CFLAGS) $(WARNINGS) $(LIBS) 

-include $(DEPENDS)

$(BUILD_DIR)/%.o: $(SOURCE_DIR)/%.c Makefile
	$(CC) -c $< -o $@  $(CFLAGS) $(WARNINGS) -MMD -MP

clean:
	$(RM) $(BINARIES) $(OBJECTS) $(DEPENDS)